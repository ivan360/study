有感于千里不留行兄的用grub4dos实现多重live启动（详见：http://forum.ubuntu.org.cn/viewtopic.php?f=77&t=226247）
但这个问题有个麻烦是必须要把内核解压到文件夹下，以grub4dos载入，进而实现live启动。
既然grub2有loopback命令可以载入iso文件，能不能直接用grub2实现硬盘liveCD的启动呢？况且grub2是U9.10默认带的，update-grub很方便，也懒的再折腾grub4dos了。
经过一晚上的google搜索和实验，已成功完成。具体思路如下：
1 将下载的iso放入分区中，分区任意。（我这里ntfs和ext4均通过，其他未测试）
2 在grub2启动项挂载iso。比如我的电脑有C: D: E: F: ，NTFS格式和ext4, swp分区。将a.iso放在D:盘根目录下。grub2启动项上按c进入命令行模式，

menuentry "Ubuntu LiveCD On D:(这里名称任意)" {
loopback lo1 (hd0,2)/a.iso
insmod ntfs
linux (lo1)/casper/vmlinuz boot=casper iso-san/filename=/a.iso noeject noprompt --
initrd (lo1)/casper/initrd.lz
}

大功告成！
依此类推，可以填加任意多个liveCD了，你的启动菜单也会变的很壮观，但其实不占用过多的硬盘空间，只是各个ISO而已。
现在可以轻松自己打包各自的liveCD，再加上grub2有自己的启动盘，这样，不管是从机子硬盘还是移动硬盘、U盘、光驱内启动grub2，都可以应用以上思路直接启动硬盘或移动硬盘、U盘内的iso文件，而且是ISO的live系统，不影响移动硬盘、U盘的正常使用， grub2实在是强大。


================================================================================

1、在U盘（/dev/sdb1）上安装grub2。
sudo mount /dev/sdb1 /mnt -t vfat  
sudo grub-install --root-directory=/mnt /dev/sdb  

2、把archlinux-2011.08-2-archboot.iso放到U盘的iso目录下（/mnt/iso/archlinux-2011.08-2-archboot.iso）
镜像下载地址：http://mirrors.163.com/archlinux/iso/archboot/2011.08/

3、然后编辑U盘grub2的启动菜单,
sudo nano /mnt/boot/grub/grub.cfg  

### BEGIN /etc/grub.d/05_debian_theme ###  
set menu_color_normal=cyan/blue  
set menu_color_highlight=white/blue  
### END /etc/grub.d/05_debian_theme  
      
set timeout=30  
set default=0  
      
# (0) archlinux-archboot.iso-x86_64  
menuentry 'archlinux-archboot.iso-x86_64' {  
loopback loop (hd0,1)/iso/archlinux-2011.08-2-archboot.iso  
linux (loop)/boot/vm64  
initrd (loop)/boot/initrd64.img rootdelay=10  
}  
      
# (1) archlinux-archboot.iso-i686  
menuentry 'archlinux-archboot.iso-i686' {  
loopback loop (hd0,1)/iso/archlinux-2011.08-2-archboot.iso  
linux (loop)/boot/vmlinuz  
initrd (loop)/boot/initrd.img rootdelay=10  
}  


4、完了就是重启系统，然后选择U盘引导启动系统。启动后就会进入安装程序，相当于执行
/arch/setup  

================================================================================

利用grub和grub2制作双系统的启动U盘

    我的U盘插上后，

    fdisk -l查看U盘信息得知是/dev/sdb

   

    先将U盘制作分区表。

    fdisk/dev/sdb

    用p命令查看得知有一个fat32分区，

    将他去掉，用d命令，

    然后用n命令新增加一个主分区，

    n后选择p（primarypartition），

    然后Partition number (1-4): 1，

    再用n命令新增加第二个主分区，

    然后用a命令，把第一个和第二个主分区设置为可引导。

    最后用w命令写入。

   

    格式化分区为ext3，

    mkfs -t ext3/dev/sdb1

    mkfs -text3 /dev/sdb2

    然后挂载系统

    mkdir/mnt/sdb1

    mount -text3 /dev/sdb1 /mnt/sdb1

    mkdir/mnt/sdb2

    mount -text3 /dev/sdb2 /mnt/sdb2

    然后将bt5光盘解开后，把casper和preseed文件夹拷贝到第一个分区的根目录下。

    将linux deepin的整个光盘iso文件放入第二个分区的根目录下。

    然后先安装grub到/mnt/sdb1

    grub-install --root-directory=/mnt/sdb1 /dev/sdb

    将/boot/grub/grub.conf拷贝到，u盘上对应的目录下

    然后编辑grub.conf

    [html]

    timeout    20

    default    0

    title     Windows 7

    map      (hd0) (hd1)

    map      (hd1) (hd0)

    rootnoverify  (hd1,0)

    makeactive

    chainloader  +1

    title backtrack 5

    root (hd0,0)

    kernel/casper/vmlinuz root=/dev/sdb1 file=/preseed/custom.seed boot=casperlocale=zh_CN text--

    initrd/casper/initrd.gz

    title linux deepin

    root (hd0,1)

    kernel/boot/grub/core.img

    savedefault

    boot

    这个配置文件就是说明，U盘第一个分区用grub引导的bt5，U盘第二个分区由grub引导core.img

    然后引导交给core.img，这个core.img是grub2的img。

    此时第二个分区上还没有core.img，这个会在后面创建，我们先这样写。

    然后将grub安装到MBR上，

    输入grub命令

    [html]

    grub> root(hd1,0)

    Filesystem type is ext2fs, partition type 0x83

    grub> setup (hd1)

    Checking if "/boot/grub/stage1"exists... yes

    Checking if "/boot/grub/stage2"exists... yes

    Checking if"/boot/grub/e2fs_stage1_5" exists... yes

    Running "embed /boot/grub/e2fs_stage1_5(hd1)"... 15 sectors are embedded.

    succeeded

    Running "install /boot/grub/stage1 (hd1)(hd1)1+15 p (hd1,0)/boot/grub/stage2 /boot/grub/grub.conf"... succeeded

    Done.

    grub> quit

    然后插着U盘重启系统，就应该可以顺利进入bt5系统了，bt5是基于ubuntu的，进入系统后，

    将grub2写入第二个分区。

    grub-install --root-directory=/mnt/sdb2 /dev/sdb

    此时写入的是grub2。

    然后编辑grub2的配置文件，grub.cfg，此文件内容如下：

    [html]

    #

    # DO NOT EDIT THISFILE

    #

    # It isautomatically generated by /usr/sbin/grub-mkconfig using templates

    # from /etc/grub.dand settings from /etc/default/grub

    #

    ### BEGIN/etc/grub.d/00_header ###

    set timeout=10

    ### END/etc/grub.d/00_header ###

    ### BEGIN/etc/grub.d/05_debian_theme ###

    setmenu_color_normal=white/black

    setmenu_color_highlight=black/light-gray

    ### END/etc/grub.d/05_debian_theme ###

    ### BEGIN/etc/grub.d/10_linux ###

    menuentry"linux deepin" {

    loopbackloop (hd0,2)/deepin_12.06_zh-hans_i386.iso

    linux(loop)/casper/vmlinuz boot=casperiso-scan/filename=/deepin_12.06_zh-hans_i386.iso locale=zh_CN.UTF-8 nopromptnoeject

    initrd(loop)/casper/initrd.lz

    }

    grub的配置文件里分区是(hd0,0)，而grub2的配置文件里分区是

    (hd0,2)，因为grub里面分区从0开始，而grub2里面分区是从1开始的。

   

    此时grub2的MBR会覆盖掉grub的MBR，所以我们需要重启系统，进入一个正常的linux系统，

    然后再执行一遍安装grub到MBR的命令，将grub的MBR覆盖掉grub2的MBR。

    [html]

    grub> root(hd1,0)

    Filesystem type is ext2fs, partition type 0x83

    grub> setup (hd1)

    Checking if "/boot/grub/stage1"exists... yes

    Checking if "/boot/grub/stage2"exists... yes

    Checking if"/boot/grub/e2fs_stage1_5" exists... yes

    Running "embed /boot/grub/e2fs_stage1_5(hd1)"... 15 sectors are embedded.

    succeeded

    Running "install /boot/grub/stage1 (hd1)(hd1)1+15 p (hd1,0)/boot/grub/stage2 /boot/grub/grub.conf"... succeeded

    Done.

    grub> quit

    此时再重启，你就拥有了双linux系统的U盘。
    
================================================================================
 3.修改grub.cfg，加入arch引导项：

———————————————————————————————

menuentry 'archlinux-2012.11.01-setup (on /usb/fairy)'{

insmod part_msdos

insmod fat

set root='hd0,msdos1'

search --no-floppy --fs-uuid --set=root 696C-0B1C

linux/arch/boot/i686/vmlinuz archisobasedir=arch archisolabel=fairy

initrd/arch/boot/i686/archiso.img

}

———————————————————————————————

说明：同上此处的696C-0B1C为U盘分区uuid，其实这一句也可以不要，因为上面已经set root了，主要为了双保险。


这里的关键是：archisobasedir=arch archisolabel=fairy ，这里的fairy是U盘的卷标，少了这句是不得成功的。 

 四、grub2引导Ubuntu liveCD

1.复制ubuntu-12.04-desktop-i386.iso到U盘根目录，当然为了根目录干净放到iso或者其他目录也可以，以下做对应修改。


2.修改grub.cfg，加入ubuntu引导项：

——————————————————————————————————————————————

menuentry 'ubuntu-12.04-desktop-i386.iso' {

insmod fat

insmod loopback

insmod iso9660

loopback loop (hd0,1)/ubuntu-12.04-desktop-i386.iso

set root=(loop)

linux /casper/vmlinuz boot=casper iso-scan/filename=/ubuntu-12.04-desktop-i386.iso noprompt noeject locale=zh_CN.UTF-8 --

initrd /casper/initrd.lz

}

——————————————————————————————————————————————

说明：

hd0,1 指得是U盘第一分区，我这里只有一个分区。

iso-scan/filename=/ubuntu-12.04-desktop-i386.iso这里要注意ubuntu前面的“/”，如果找不到文件会出现can't open /dev/sr0错误。

locale=zh_CN.UTF-8 是设置中文环境，很多人引导成功却是英文环境的，加上这条就可以了。


vim:set ft=txt:
